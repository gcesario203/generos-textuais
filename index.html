<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <title>Ilha Perdida</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root{
      --panel-bg: rgba(15,22,35,0.72);
      --accent: #ffd14a;
      --muted: #bcd1e6;
      --ui-blue: #24425a;
      --glass: rgba(255,255,255,0.06);
    }
    *{box-sizing:border-box}
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;background:#071024;color:#e9f1f7}
    header{
      display:flex;align-items:center;justify-content:space-between;padding:14px 18px;background:linear-gradient(180deg,#062033,#071a2a);
      border-bottom:1px solid rgba(255,255,255,0.03);backdrop-filter: blur(4px);
    }
    header .title{font-weight:700;color:var(--accent);font-size:16px;display:flex;gap:10px;align-items:center}
    header .subtitle{font-size:13px;color:var(--muted)}
    main{display:flex;flex:1;min-height:0}
    #game-area{flex:2;display:flex;align-items:center;justify-content:center;padding:18px}
    canvas{border-radius:12px;box-shadow:0 8px 30px rgba(2,8,20,0.7);background:#091225}
    aside{flex:1;padding:18px;background:linear-gradient(180deg,rgba(6,22,36,0.5),rgba(3,10,18,0.6));border-left:1px solid rgba(255,255,255,0.02)}
    .panel{background:var(--panel-bg);padding:12px;border-radius:10px;margin-bottom:12px;box-shadow:inset 0 1px 0 rgba(255,255,255,0.02)}
    .panel h3{margin:0 0 8px 0;color:var(--accent);font-size:14px}
    #inventory{display:flex;gap:8px;align-items:center}
    .slot{width:72px;height:72px;border-radius:10px;background:linear-gradient(180deg,rgba(255,255,255,0.02),rgba(0,0,0,0.06));display:flex;align-items:center;justify-content:center;color:#dbeaf8;border:1px solid rgba(255,255,255,0.03);cursor:pointer;flex-direction:column;font-size:12px}
    .slot.filled{border-color:var(--accent);background:linear-gradient(180deg,rgba(255,210,74,0.08), rgba(0,0,0,0.08))}
    #craft-btn{width:100%;padding:9px;border-radius:8px;border:none;background:linear-gradient(180deg,#ffd14a,#f0b020);color:#041423;font-weight:700;cursor:pointer;margin-top:8px;box-shadow:0 6px 18px rgba(15,22,38,0.45)}
    #craft-btn:disabled{opacity:0.45;cursor:not-allowed;box-shadow:none}
    #log{height:140px;overflow:auto;background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(0,0,0,0.07));padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.02);font-size:13px;color:var(--muted)}
    footer{padding:8px 18px;font-size:12px;color:#9fbdd8;background:linear-gradient(180deg,#051021,#061427);border-top:1px solid rgba(255,255,255,0.02)}
    /* overlays */
    .overlay{position:fixed;inset:0;display:none;align-items:center;justify-content:center;background:linear-gradient(180deg,rgba(1,6,10,0.6),rgba(0,0,0,0.75));z-index:40}
    .popup{width:92%;max-width:520px;background:#f7f9fb;color:#0b1a24;padding:18px;border-radius:12px;box-shadow:0 12px 40px rgba(0,0,0,0.6);border:1px solid rgba(2,8,20,0.08)}
    .popup h2{margin:0 0 8px 0;color:#183b53}
    .popup p{margin:8px 0;line-height:1.45}
    .popup .link{color:#1366cc;text-decoration:underline;cursor:pointer;font-weight:600}
    .popup .actions{display:flex;gap:8px;margin-top:12px;justify-content:flex-end}
    .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer;background:#183b53;color:#fff;font-weight:700}
    .btn.secondary{background:#e6eef7;color:#083047}
    .dialog-option{padding:10px;border-radius:8px;background:#eef6ff;color:#023047;cursor:pointer;border:1px solid rgba(2,20,40,0.06)}
    .dialog-option:hover{transform:translateX(6px);transition:all .18s}
    /* responsiveness */
    @media (max-width:900px){main{flex-direction:column}aside{order:2;width:100%}#game-area{order:1;padding:12px}canvas{width:100%;height:auto}}
  </style>
</head>
<body>
  <header>
    <div class="title">Ilha Perdida</div>
    <div class="subtitle">Movimento: WASD / Setas ‚Ä¢ Examinar: Clique no item no invent√°rio ‚Ä¢ Crafting: bot√£o</div>
  </header>

  <main>
    <div id="game-area">
      <canvas id="game" width="780" height="560"></canvas>
    </div>

    <aside>
      <div class="panel">
        <h3>üéí Invent√°rio</h3>
        <div id="inventory" aria-live="polite">
          <!-- slots in JS -->
        </div>
      </div>

      <div class="panel">
        <h3>üîß Crafting</h3>
        <div style="font-size:13px;color:var(--muted)">Combine <strong>GALHO</strong> + <strong>PEDRA PONTIAGUDA</strong></div>
        <button id="craft-btn" disabled>üîß Criar Faca Rudimentar</button>
      </div>

      <div class="panel">
        <h3>üìú Registro</h3>
        <div id="log"></div>
      </div>
    </aside>
  </main>

  <footer>Atividade: G√™neros Textuais em Jogos Digitais - Prof.¬™ S√≠lvia</footer>

  <!-- Overlays: Tela1, Tela2, Tela3 -->
  <div class="overlay" id="overlay-help">
    <div class="popup">
      <h2>üìã Tela 1 - Ajuda: Como criar sua primeira ferramenta</h2>
      <p>Voc√™ j√° coletou <strong>GALHO</strong> e <strong>PEDRA PONTIAGUDA</strong>. Para criar a <strong>Faca Rudimentar</strong>:</p>
      <ol>
        <li>Abra o painel de <strong>Crafting</strong> (bot√£o ao lado).</li>
        <li>Clique em <strong>"üîß Criar Faca Rudimentar"</strong> quando dispon√≠vel.</li>
        <li>Use a faca para cortar materiais e aumentar suas chances de sobreviver.</li>
      </ol>
      <div class="actions">
        <button class="btn" id="close-help">Entendi</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay-branch">
    <div class="popup">
      <h2>üîç Tela 2 - Pista: Descri√ß√£o do Galho</h2>
      <p>Um peda√ßo de madeira enegrecido nas pontas, com fibras que indicam resist√™ncia. Parece ter vindo de uma √°rvore antiga que suportou muitas tempestades.</p>
      <p>Este galho lembra os exemplares do <span class="link" id="link-ancient">Salgueiro-Anci√£o</span>.</p>
      <div id="ancient-info" style="display:none;margin-top:10px;padding:10px;background:#fff8dc;border-radius:8px;border:1px solid #f0e0b0;color:#1a2a3a">
        <strong>Salgueiro-Anci√£o:</strong> √°rvore nativa da ilha. Madeira flex√≠vel e muito resistente - ideal para cabos de ferramentas.
      </div>
      <div class="actions">
        <button class="btn secondary" id="close-branch">Fechar</button>
      </div>
    </div>
  </div>

  <div class="overlay" id="overlay-valkiria">
    <div class="popup">
      <h2>üìª Tela 3 - Rea√ß√£o: Mensagem de Valkiria</h2>
      <p><strong>Walkie-talkie:</strong> um estalo e uma voz distante.</p>
      <p><strong>Valkiria:</strong> ‚ÄúVejo que improvisou uma faca. Use-a bem - a ilha √© implac√°vel. N√£o perca recursos.‚Äù</p>
      <p><strong>Escolha sua resposta:</strong></p>
      <div style="display:flex;flex-direction:column;gap:8px;margin-top:8px">
        <div class="dialog-option" id="opt-coop">1) ü§ù Cooperativa: ‚ÄúObrigado, vou seguir suas instru√ß√µes. Quero ajuda.‚Äù</div>
        <div class="dialog-option" id="opt-susp">2) ü§® Desconfiada: ‚ÄúQuem √© voc√™? Por que eu deveria confiar?‚Äù</div>
      </div>
      <div id="valk-feedback" style="margin-top:12px;color:#113046;font-style:italic"></div>
      <div class="actions" style="margin-top:10px">
        <button class="btn" id="close-valk">Encerrar</button>
      </div>
    </div>
  </div>

  <script>
  // -----------------------
  // Config e utilit√°rios
  // -----------------------
  const canvas = document.getElementById('game');
  const ctx = canvas.getContext('2d', { alpha: false });
  let W = canvas.width, H = canvas.height;

  function resizeCanvas(){
    const dpr = Math.min(window.devicePixelRatio || 1, 2);
    const rect = canvas.getBoundingClientRect();
    W = rect.width || canvas.width;
    H = rect.height || canvas.height;
    canvas.width = Math.floor(W * dpr);
    canvas.height = Math.floor(H * dpr);
    canvas.style.width = W + 'px';
    canvas.style.height = H + 'px';
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  window.addEventListener('resize', resizeCanvas);
  resizeCanvas();

  // helper: roundRect (fix for "roundRect is not defined")
  function roundRect(ctx, x, y, w, h, r) {
    if (typeof r === 'undefined') r = 6;
    const radius = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x + radius, y);
    ctx.arcTo(x + w, y, x + w, y + h, radius);
    ctx.arcTo(x + w, y + h, x, y + h, radius);
    ctx.arcTo(x, y + h, x, y, radius);
    ctx.arcTo(x, y, x + w, y, radius);
    ctx.closePath();
  }

  // Keep beep/audio from original (left intact)
  const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
  function beep(freq=440,dur=0.06,vol=0.08){
    try{
      const o = audioCtx.createOscillator();
      const g = audioCtx.createGain();
      o.type = 'sine';
      o.frequency.value = freq;
      g.gain.value = vol;
      o.connect(g); g.connect(audioCtx.destination);
      o.start();
      o.stop(audioCtx.currentTime + dur);
    }catch(e){/*ignore*/}
  }

  // -----------------------
  // World & visuals (improved)
  // -----------------------
  const world = {
    time: 0,
    waterRatio: 0.12,     // reduced water height
    sandOffset: 0.20      // where sand starts after water
  };

  function sandTop() {
    return H * (world.waterRatio + world.sandOffset);
  }

  // particles (vagalumes/leves)
  const particles = [];
  function spawnParticle(){
    particles.push({
      x: Math.random()*W,
      y: sandTop() + Math.random()*(H - sandTop() - 40),
      vx: (Math.random()*0.6)-0.3,
      vy: (Math.random()*0.2)-0.05,
      r: 1 + Math.random()*2,
      life: 120 + Math.random()*240,
      type: Math.random()>0.75 ? 'spark' : 'leaf'
    });
  }
  for(let i=0;i<24;i++) spawnParticle();

  // Collect particles
  const collectParticles = [];

  // -----------------------
  // Game entities (ensure on sand)
  // -----------------------
  const player = {
    x: 380, y: 380, r: 14, speed: 2.2, color:'#1f6fe6'
  };

  const worldItems = [
    { id:'branch', name:'Galho', x:140, y: sandTop() + 70, collected:false, bounce:0 },
    { id:'stone', name:'PEDRA PONTIAGUDA', x:620, y: sandTop() + 130, collected:false, bounce:0 }
  ];

  const inventory = [];

  // -----------------------
  // Input
  // -----------------------
  const keys = {};
  window.addEventListener('keydown', (e)=>{ keys[e.key.toLowerCase()]=true; if(e.key===' '){e.preventDefault();} });
  window.addEventListener('keyup', (e)=>{ keys[e.key.toLowerCase()]=false; });

  // -----------------------
  // Utility
  // -----------------------
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }
  function log(msg){
    const logEl = document.getElementById('log');
    const div = document.createElement('div');
    div.innerHTML = msg;
    div.className = 'entry';
    logEl.appendChild(div);
    logEl.scrollTop = logEl.scrollHeight;
  }

  // -----------------------
  // Inventory UI
  // -----------------------
  const invRoot = document.getElementById('inventory');
  function createInventorySlots(){
    invRoot.innerHTML = '';
    const ids = ['branch','stone','knife'];
    ids.forEach(id=>{
      const div = document.createElement('div');
      div.className = 'slot';
      div.dataset.slot = id;
      div.innerHTML = '<div class="label">Vazio</div>';
      invRoot.appendChild(div);
      div.addEventListener('click', ()=>{
        if(id==='branch' && inventory.some(i=>i.id==='branch')) {
          document.getElementById('overlay-branch').style.display='flex';
        }
      });
    });
  }
  function updateInventoryUI(){
    const slots = invRoot.querySelectorAll('.slot');
    slots.forEach(slot=>{
      const id = slot.dataset.slot;
      slot.classList.remove('filled');
      if(id==='branch' && inventory.some(i=>i.id==='branch')){
        slot.classList.add('filled'); slot.innerHTML = 'ü™µ<div style="font-size:11px">Galho</div>';
      } else if(id==='stone' && inventory.some(i=>i.id==='stone')){
        slot.classList.add('filled'); slot.innerHTML = 'ü™®<div style="font-size:11px">Pedra</div>';
      } else if(id==='knife' && inventory.some(i=>i.id==='knife')){
        slot.classList.add('filled'); slot.innerHTML = 'üî™<div style="font-size:11px">Faca</div>';
      } else {
        slot.innerHTML = '<div class="label">Vazio</div>';
      }
    });
  }
  createInventorySlots(); updateInventoryUI();

  // -----------------------
  // Collect & effects
  // -----------------------
  function addCollectEffect(x,y){
    for(let i=0;i<12;i++){
      collectParticles.push({
        x, y,
        vx: (Math.random()*4-2),
        vy: (Math.random()*-3-0.6),
        r: 2 + Math.random()*2,
        life: 28 + Math.random()*36,
        c: (Math.random()>0.6 ? '#ffd14a' : '#fff')
      });
    }
  }
  function collectItem(it){
    if(it.collected) return;
    it.collected = true;
    inventory.push({id:it.id,name:it.name});
    updateInventoryUI();
    addCollectEffect(it.x,it.y);
    try{ beep(700,0.07,0.06); }catch(e){}
    log(`‚úî Voc√™ coletou: <strong>${it.name}</strong>.`);
    checkCraftAvailability();
  }

  // -----------------------
  // Crafting & overlays (keep behaviors)
  // -----------------------
  const craftBtn = document.getElementById('craft-btn');
  craftBtn.addEventListener('click', ()=>{
    if(inventory.some(i=>i.id==='branch') && inventory.some(i=>i.id==='stone') && !inventory.some(i=>i.id==='knife')){
      inventory.push({id:'knife',name:'Faca Rudimentar'});
      log('üî® Voc√™ criou: <strong>Faca Rudimentar</strong>.');
      updateInventoryUI(); try{ beep(420,0.09,0.09); }catch(e){}
      setTimeout(()=> document.getElementById('overlay-valkiria').style.display='flex', 420);
    }
    checkCraftAvailability();
  });
  function checkCraftAvailability(){
    const c = inventory.some(i=>i.id==='branch') && inventory.some(i=>i.id==='stone') && !inventory.some(i=>i.id==='knife');
    craftBtn.disabled = !c;
  }

  // overlay handlers & link toggle (KEEP the hyperlink behavior exactly)
  document.getElementById('close-help').addEventListener('click', ()=>document.getElementById('overlay-help').style.display='none');
  document.getElementById('close-branch').addEventListener('click', ()=>{
    document.getElementById('overlay-branch').style.display='none';
    const b = worldItems.find(it=>it.id==='branch');
    if(b && !b.collected) collectItem(b);
  });
  document.getElementById('link-ancient').addEventListener('click', ()=>{
    const el = document.getElementById('ancient-info'); el.style.display = el.style.display==='block' ? 'none' : 'block';
  });
  document.getElementById('close-valk').addEventListener('click', ()=>document.getElementById('overlay-valkiria').style.display='none');
  document.getElementById('opt-coop').addEventListener('click', ()=>{
    document.getElementById('valk-feedback').textContent = 'Voc√™ escolheu cooperar - Valkiria responde com rotas e dicas.';
    log('Voc√™ respondeu de forma cooperativa para Valkiria.');
    try{ beep(600,0.08,0.06); }catch(e){}
  });
  document.getElementById('opt-susp').addEventListener('click', ()=>{
    document.getElementById('valk-feedback').textContent = 'Voc√™ respondeu desconfiado - a comunica√ß√£o fica tensa.';
    log('Voc√™ respondeu desconfiado para Valkiria.');
    try{ beep(220,0.08,0.06); }catch(e){}
  });

  // -----------------------
  // Drawing helpers (enhanced visuals)
  // -----------------------
  function drawSky(){
    const g = ctx.createLinearGradient(0,0,0, sandTop()*0.9);
    g.addColorStop(0,'#06152a'); g.addColorStop(1,'#154f79');
    ctx.fillStyle = g; ctx.fillRect(0,0,W, sandTop()*0.9);

    // moon / glow
    const mx = W*0.12, my = sandTop()*0.18, mr = 36;
    const mg = ctx.createRadialGradient(mx,my,4,mx,my,mr*1.8);
    mg.addColorStop(0,'rgba(255,245,200,0.98)'); mg.addColorStop(1,'rgba(255,245,200,0)');
    ctx.fillStyle = mg; ctx.beginPath(); ctx.arc(mx,my,mr*1.8,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = 'rgba(255,255,245,0.95)'; ctx.beginPath(); ctx.arc(mx,my,28,0,Math.PI*2); ctx.fill();

    // soft stars
    ctx.save(); ctx.globalAlpha = 0.85; ctx.fillStyle = '#eaf7ff';
    for(let i=0;i<80;i++){
      const x = (i*123 + world.time*0.5) % W;
      const y = 8 + (i*47)% (sandTop()*0.45);
      ctx.beginPath(); ctx.arc(x,y, (i%11===0)?1.6:0.9,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  function drawWater(){
    const top = 0;
    const h = H * world.waterRatio;
    const g = ctx.createLinearGradient(0,top,0,top+h);
    g.addColorStop(0,'#0f6e95'); g.addColorStop(1,'#2aa7dc');
    ctx.fillStyle = g; ctx.fillRect(0, top, W, h);

    // foam line (sine)
    ctx.save(); ctx.globalAlpha = 0.9; ctx.strokeStyle = 'rgba(255,255,255,0.36)'; ctx.lineWidth = 1.6;
    for(let x=0;x<W;x+=12){
      const y = top + h - 8 + Math.sin((x*0.05) + world.time*0.06)*4;
      ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x+8, y + Math.sin((x*0.03)+world.time*0.12)*2); ctx.stroke();
    }
    ctx.restore();
  }

  function drawSand(){
    const y = sandTop();
    const g = ctx.createLinearGradient(0,y,0,H);
    g.addColorStop(0,'#f2d6a5'); g.addColorStop(1,'#e3c48a');
    ctx.fillStyle = g; ctx.fillRect(0,y,W,H-y);

    // subtle grains & paths
    ctx.save(); ctx.globalAlpha = 0.18; ctx.fillStyle = '#e0c392';
    for(let i=0;i<250;i++){
      const sx = (i*83 + (world.time*0.12)) % W;
      const sy = y + 20 + (i*47)% (H - y - 20);
      ctx.beginPath(); ctx.ellipse(sx,sy,1.6,1,0,0,Math.PI*2); ctx.fill();
    }
    ctx.restore();
  }

  function drawPalm(ctx,x,y,scale=1,flip=false){
    ctx.save(); ctx.translate(x,y); if(flip) ctx.scale(-1,1); ctx.scale(scale,scale);
    // trunk
    ctx.fillStyle = '#6a3f17';
    roundRect(ctx, -8, -44, 16, 44, 8); ctx.fill();
    for(let i=6;i<40;i+=6){ ctx.fillStyle = '#5b3512'; ctx.fillRect(-8, i-44, 16, 3); }
    // leaves
    ctx.translate(0,-50);
    for(let i=0;i<6;i++){
      ctx.save();
      ctx.rotate((i-2.5)/6 * Math.PI * 1.05);
      ctx.beginPath();
      ctx.fillStyle = i%2==0 ? '#2a7b2a' : '#2f8a2f';
      ctx.moveTo(0,0);
      ctx.quadraticCurveTo(60,-10,120,4);
      ctx.quadraticCurveTo(60,10,0,0);
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,0.07)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(16,0); ctx.lineTo(90,2); ctx.stroke();
      ctx.restore();
    }
    ctx.restore();
  }

  function drawRock(ctx,x,y,scale=1){
    ctx.save(); ctx.translate(x,y); ctx.scale(scale,scale);
    ctx.beginPath(); ctx.fillStyle = 'rgba(0,0,0,0.18)'; ctx.ellipse(0,10,28,10,0,0,Math.PI*2); ctx.fill();
    ctx.fillStyle = '#7b7b7b';
    ctx.beginPath(); ctx.moveTo(-20,-6); ctx.quadraticCurveTo(-26,-10,-12,-18); ctx.quadraticCurveTo(8,-28,20,-12); ctx.quadraticCurveTo(28,0,12,10); ctx.quadraticCurveTo(-2,26,-24,8); ctx.fill();
    ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.beginPath(); ctx.moveTo(-8,-6); ctx.quadraticCurveTo(0,-12,10,-8); ctx.quadraticCurveTo(6,-2,-8,0); ctx.fill();
    ctx.restore();
  }

  function drawPalmCluster(){
    drawPalm(ctx, 110, sandTop()+60, 0.72, false);
    drawPalm(ctx, 200, sandTop()+80, 0.9, true);
    drawPalm(ctx, 70, sandTop()+110, 0.6, true);
    drawPalm(ctx, 260, sandTop()+120, 0.66, false);
  }

  function drawRocksAndShells(){
    drawRock(ctx, 520, sandTop()+150, 1.1);
    drawRock(ctx, 440, sandTop()+120, 0.7);
    drawRock(ctx, 680, sandTop()+170, 0.95);
  }

  function drawItems(){
    worldItems.forEach(it=>{
      if(it.collected) return;
      ctx.save();
      const bob = Math.sin((world.time + it.x)*0.07)*4;
      it.bounce = bob;
      // shadow
      ctx.beginPath(); ctx.fillStyle = 'rgba(0,0,0,0.22)'; ctx.ellipse(it.x, it.y+18, 16, 6, 0,0,Math.PI*2); ctx.fill();

      // glow
      const glowR = 22;
      const g = ctx.createRadialGradient(it.x, it.y + bob, 2, it.x, it.y + bob, glowR);
      g.addColorStop(0, 'rgba(255,238,140,0.9)');
      g.addColorStop(0.25, 'rgba(255,205,80,0.45)');
      g.addColorStop(1, 'rgba(255,205,80,0)');
      ctx.globalCompositeOperation = 'lighter';
      ctx.fillStyle = g; ctx.beginPath(); ctx.arc(it.x, it.y + bob, glowR,0,Math.PI*2); ctx.fill();
      ctx.globalCompositeOperation = 'source-over';

      if(it.id==='branch'){
        ctx.translate(it.x, it.y + bob); ctx.rotate(-0.14);
        ctx.fillStyle='#6b3f19'; ctx.fillRect(-36, -6, 72, 10);
        ctx.fillStyle='#4b2a10'; ctx.fillRect(-12,-10,8,5); ctx.fillRect(18,-6,6,4);
        ctx.beginPath(); ctx.strokeStyle='#6b3f19'; ctx.lineWidth=4; ctx.moveTo(-2,-6); ctx.lineTo(-26,-18); ctx.stroke();
      } else {
        ctx.translate(it.x, it.y + bob); ctx.rotate(it.x*0.008);
        ctx.fillStyle = '#6a6a6a';
        ctx.beginPath(); ctx.moveTo(-18,-6); ctx.quadraticCurveTo(-10,-22,8,-16); ctx.quadraticCurveTo(28,-6,16,12); ctx.quadraticCurveTo(-6,28,-24,8); ctx.closePath(); ctx.fill();
        ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.beginPath(); ctx.moveTo(-4,-6); ctx.quadraticCurveTo(6,-12,12,-6); ctx.fill();
      }
      ctx.restore();
    });
  }

  function drawPlayer(){
    // shadow
    ctx.beginPath(); ctx.fillStyle = 'rgba(0,0,0,0.28)'; ctx.ellipse(player.x, player.y+18, player.r*1.3, player.r*0.55,0,0,Math.PI*2); ctx.fill();

    ctx.save();
    ctx.translate(player.x, player.y);
    const bob = Math.sin(world.time*0.08)*3;
    ctx.translate(0, bob*0.2);
    // torso
    ctx.fillStyle = player.color; roundRect(ctx, -12, -20, 24, 28, 6); ctx.fill();
    // head
    ctx.beginPath(); ctx.fillStyle = '#000000'; ctx.arc(0, -28, 8, 0, Math.PI*2); ctx.fill();
    // small highlights
    ctx.fillStyle='rgba(255,255,255,0.06)'; ctx.fillRect(-8, -14, 16, 4);
    ctx.restore();
  }

  function drawUI(){
    const g = ctx.createRadialGradient(W/2,H/2,20,W/2,H/2,Math.max(W,H));
    g.addColorStop(0,'rgba(0,0,0,0)');
    g.addColorStop(1,'rgba(0,0,0,0.12)');
    ctx.fillStyle=g; ctx.fillRect(0,0,W,H);
  }

  // -----------------------
  // Update & Loop
  // -----------------------
  function step(){
    world.time += 1;
    // movement
    let dx=0, dy=0;
    if(keys['w']||keys['arrowup']) dy -= player.speed;
    if(keys['s']||keys['arrowdown']) dy += player.speed;
    if(keys['a']||keys['arrowleft']) dx -= player.speed;
    if(keys['d']||keys['arrowright']) dx += player.speed;
    if(dx!==0 && dy!==0){ dx *= 0.7071; dy *= 0.7071; }
    player.x = clamp(player.x + dx, 60, W-60);
    // clamp player to sand area only
    player.y = clamp(player.y + dy, sandTop() + 30, H-60);

    // item proximity
    worldItems.forEach(it=>{
      if(it.collected) return;
      const dd = Math.hypot(player.x - it.x, player.y - it.y);
      if(dd < 30){
        collectItem(it);
      }
    });

    // update particles
    for(let i=particles.length-1;i>=0;i--){
      const p = particles[i];
      p.x += p.vx; p.y += p.vy + Math.sin((world.time + i)*0.02)*0.2;
      p.life--;
      if(p.x < -20) p.x = W + 20;
      if(p.x > W + 20) p.x = -20;
      if(p.y < sandTop() || p.y > H + 40) p.y = sandTop() + Math.random()*(H - sandTop() - 40);
      if(p.life < 0){ particles.splice(i,1); spawnParticle(); }
    }

    // collectParticles update
    for(let i=collectParticles.length-1;i>=0;i--){
      const p = collectParticles[i]; p.vy += 0.12; p.x += p.vx; p.y += p.vy; p.life--;
      if(p.life<=0) collectParticles.splice(i,1);
    }

    // show help overlay once if both items collected (no knife)
    if(inventory.some(i=>i.id==='branch') && inventory.some(i=>i.id==='stone') && !inventory.some(i=>i.id==='knife')){
      if(!window._helpShownOnce){
        window._helpShownOnce = true;
        setTimeout(()=>document.getElementById('overlay-help').style.display='flex', 600);
      }
    }

    // occasional spawn
    if(Math.random() < 0.04) spawnParticle();
  }

  function draw(){
    ctx.clearRect(0,0,W,H);
    drawSky();
    drawWater();
    drawSand();
    drawPalmCluster();
    drawRocksAndShells();
    drawItems();
    drawPlayer();

    // collect particles
    collectParticles.forEach(p=>{
      ctx.beginPath(); ctx.fillStyle = p.c; ctx.globalAlpha = Math.max(0, p.life/40); ctx.arc(p.x, p.y, p.r,0,Math.PI*2); ctx.fill(); ctx.globalAlpha = 1;
    });

    // floating particles (vagalumes)
    particles.forEach(p=>{
      ctx.save();
      const grad = ctx.createRadialGradient(p.x, p.y, 0, p.x, p.y, 12);
      grad.addColorStop(0, `rgba(255,245,160,${0.6 + (p.r/4)})`);
      grad.addColorStop(1, 'rgba(255,245,160,0)');
      ctx.fillStyle = grad; ctx.beginPath(); ctx.arc(p.x, p.y, 8,0,Math.PI*2); ctx.fill();
      ctx.restore();
    });

    drawUI();
  }

  function loop(){
    step();
    draw();
    requestAnimationFrame(loop);
  }
  loop();

  // -----------------------
  // Init & helpers
  // -----------------------
  log('Voc√™ acordou na praia. Procure recursos: <strong>galho</strong> e <strong>pedra</strong>.');
  createInventorySlots(); updateInventoryUI();

  // ensure items and player always begin on sand area if canvas resized
  function enforceStartPositions(){
    const sTop = sandTop();
    worldItems.forEach(it=>{
      if(it.y < sTop + 30) it.y = sTop + 60 + Math.random()*80;
      it.x = clamp(it.x, 80, W-80);
    });
    player.x = clamp(player.x, 60, W-60);
    player.y = clamp(player.y, sTop + 60, H-60);
  }
  enforceStartPositions();
  window.addEventListener('resize', enforceStartPositions);

  // resume audio on user gesture (keeps behavior from original)
  window.addEventListener('pointerdown', ()=>{ if(audioCtx.state==='suspended') audioCtx.resume(); }, { once:true });

  </script>
</body>
</html>